<<<<<<< HEAD
{{- $lang := site.Language.LanguageCode | default `en` -}}

{{- with site.Params.comments.giscus -}}
<script>
  /*
   * "preferred color scheme" theme in giscus works using "prefers-color-scheme" in media query.
   * but, hugo's theme switch function works by using "color-theme" in local storage.
   * This solution was created with reference to:
   * https://github.com/giscus/giscus/issues/336#issuecomment-1214366281
  */
  function getHugoTheme() {
    return localStorage.getItem("color-theme");
  }
  
  function getGiscusTheme() {
    let giscusTheme = "{{ (string .theme) | default `light` }}";
    if(getHugoTheme() == 'light') {
      return giscusTheme.replace('dark', 'light');
    } else {
      return giscusTheme.replace('light', 'dark');
    }
  }

  function setGiscusTheme() {
    function sendMessage(message) {
      const iframe = document.querySelector('iframe.giscus-frame');
      if (!iframe) return;
      iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
    }
    sendMessage({
      setConfig: {
        theme: getGiscusTheme(),
      },
    });
=======
{{- $lang := site.Language.Lang | default `en` -}}
{{- if hasPrefix $lang "zh" -}}
  {{- /* See: https://github.com/giscus/giscus/tree/main/locales */}}
  {{- $lang = site.Language.LanguageCode | default `zh-CN` -}}
{{- end -}}

{{- with site.Params.comments.giscus -}}
<script>
  function getGiscusTheme() {
    const giscusTheme = '{{ .theme }}';
    if (giscusTheme === 'light' || giscusTheme === 'dark') {
      return giscusTheme;
    }

    const hugoTheme = localStorage.getItem("color-theme");
    if (hugoTheme === 'light' || hugoTheme === 'dark') {
      return hugoTheme;
    }

    if (hugoTheme === 'system') {
      return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    }

    const defaultTheme = '{{ site.Params.theme.default }}';
    if (defaultTheme === 'light' || defaultTheme === 'dark') {
      return defaultTheme;
    }

    return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
  }

  function setGiscusTheme() {
    const iframe = document.querySelector('iframe.giscus-frame');
    if (!iframe) return;

    const msg = {
      giscus: {
        setConfig: {
          theme: getGiscusTheme(),
        },
      },
    }

    iframe.contentWindow.postMessage(msg, 'https://giscus.app');
>>>>>>> 2cd534b (first2)
  }

  document.addEventListener('DOMContentLoaded', function () {
    const giscusAttributes = {
      "src": "https://giscus.app/client.js",
      "data-repo": "{{ .repo }}",
      "data-repo-id": "{{ .repoId }}",
      "data-category": "{{ .category }}",
      "data-category-id": "{{ .categoryId }}",
      "data-mapping": "{{ .mapping | default `pathname` }}",
      "data-strict": "{{ (string .strict) | default 0 }}",
      "data-reactions-enabled": "{{ (string .reactionsEnabled) |  default 1 }}",
      "data-emit-metadata": "{{ (string .emitMetadata) | default 0 }}",
      "data-input-position": "{{ .inputPosition | default `top` }}",
      "data-theme": getGiscusTheme(),
      "data-lang": "{{ .lang | default $lang }}",
      "crossorigin": "anonymous",
      "async": "",
    };

    // Dynamically create script tag
    const giscusScript = document.createElement("script");
    Object.entries(giscusAttributes).forEach(([key, value]) => giscusScript.setAttribute(key, value));
<<<<<<< HEAD
    document.getElementById('giscus').appendChild(giscusScript);

    // Update giscus theme when theme switcher is clicked
    const toggles = document.querySelectorAll(".theme-toggle");
    if (toggles) {
      toggles.forEach(toggle => toggle.addEventListener('click', setGiscusTheme));
=======
    // Random hash id to avoid conflicts with titles inside pages.
    document.getElementById('giscus-hextra-bb112b9f807c37c1752e5da6a1652a29').appendChild(giscusScript);

    // Listen for system theme changes
    window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change", setGiscusTheme);

    // Update giscus theme when theme switcher is clicked
    const themeToggleOptions = document.querySelectorAll(".hextra-theme-toggle-options p");
    if (themeToggleOptions) {
      themeToggleOptions.forEach(toggle => toggle.addEventListener('click', setGiscusTheme));
>>>>>>> 2cd534b (first2)
    }
  });
</script>

<<<<<<< HEAD
<div id="giscus"></div>
=======
<div id="giscus-hextra-bb112b9f807c37c1752e5da6a1652a29"></div>
>>>>>>> 2cd534b (first2)
{{- else -}}
  {{ warnf "giscus is not configured" }}
{{- end -}}
